/*

Documentation of methods used to transform and clean bronze tables to move 
to silver layer

Quality checks

It includes checks for
Null or duplicate primary keys
Unwanted spaces in string fields
Data standardization
Invalid date range and orders
Data consistency between related fields

Run checks after loading silver layer
Investigate and resolve any discrepancies found during the checks

--crm_cust_info table
-- check for nulls or duplicates in primary key

Select
cst_id,
count(*) as number
from
bronze.crm_cust_info
group by cst_id
having count (*) > 1 or cst_id is null

-- Data transformation
-- select 1 cst_id duplicate to check information
select
*
from 
bronze.crm_cust_info
where cst_id = 29466

--We want to use the last creation date as the valid record
--

select
*,
row_number () over (partition by cst_id order by cst_create_date desc) as flag
from 
bronze.crm_cust_info
where cst_id = 29466

-- Checking full table
Select 
*
from (
select
*,
row_number () over (partition by cst_id order by cst_create_date desc) as flag
from 
bronze.crm_cust_info
)t where flag != 1

-- Creating table with values of only flag = 1
--cleaning data
--Insert table
print '<<Truncating table:  silver.crm_cust_info';
truncate table  silver.crm_cust_info;
print '<<Inserting data into: silver.crm_cust_info';
insert into silver.crm_cust_info(
cst_id,
cst_key,
cst_firstname,
cst_lastname,
cst_marital_status,
cst_gndr,
cst_create_date)
Select 
cst_id,
cst_key,
Trim(cst_firstname) as cst_first_name,
Trim(cst_lastname) as cst_lastname,
case
when upper(trim(cst_marital_status)) = 'S' then 'Single'
when upper(trim(cst_marital_status)) = 'M' then 'Married'
else 'N/A'
end as cst_marital_status,
case
when upper(trim(cst_gndr)) = 'F' then 'Female'
when upper(trim(cst_gndr)) = 'M' then 'Male'
else 'N/A'
end as cst_gndr,
cst_create_date
from (
select
*,
row_number () over (partition by cst_id order by cst_create_date desc) as flag
from 
bronze.crm_cust_info
where cst_id is not null
)t where flag = 1

--check for unwanted spaces
select 
cst_firstname
from 
bronze.crm_cust_info
where cst_firstname != trim(cst_firstname)


--check for unwanted spaces
select 
cst_lastname
from 
bronze.crm_cust_info
where cst_firstname != trim(cst_lastname)

--check for unwanted spaces
select 
cst_firstname
from 
bronze.crm_cust_info
where cst_firstname != trim(cst_firstname)

--data standardization
select distinct cst_gndr
from
bronze.crm_cust_info

--update table
if object_id ('silver.crm_prd_info' , 'U') is not null
 drop table silver.crm_prd_info;
create table silver.crm_prd_info (
prd_id int,
cat_id nvarchar (50),
prd_key nvarchar (50),
prd_nm nvarchar (50),
prd_cost int,
prd_line nvarchar (50),
prd_start_dt date,
prd_end_dt date,
dwh_create_date datetime2 default getdate()
);
--crm_prd_info table
--create cat_id column
--insert table
print '<<Truncating table:  silver.crm_prd_info';
truncate table  silver.crm_prd_info;
print '<<Inserting data into: silver.crm_prd_info';
insert into silver.crm_prd_info(
prd_id,
cat_id,
prd_key,
prd_nm,
prd_cost,
prd_line,
prd_start_dt,
prd_end_dt)
select
prd_id,

replace(substring (prd_key,1,5), '-', '_') as cat_id,
substring(prd_key, 7, len(prd_key)) as prd_key,
prd_nm,
isnull(prd_cost, 0) as prd_cost,

case when upper(trim(prd_line)) = 'M' then 'Mountain'
when upper(trim(prd_line)) = 'R' then 'Road'
when upper(trim(prd_line)) = 'S' then 'Other sale'
when upper(trim(prd_line)) = 'T' then 'Touring'
else 'N/A'
end as prd_line,
cast(prd_start_dt as date) as prd_start_dt,
cast(lead (prd_start_dt) over (partition by prd_key order by prd_start_dt) -1 as date) as  prd_end_dt
from 
bronze.crm_prd_info

--check for duplicates or nulls
select
prd_id,
count(*)
from
bronze.crm_prd_info
group by prd_id
having count(*) > 1 or prd_id is null

--check for null or negative numbers
select
prd_cost
from
bronze.crm_prd_info
where prd_cost < 0 or prd_cost is null


--data standardization
select distinct prd_line
from 
bronze.crm_prd_info

--date validation
select
*
from
bronze.crm_prd_info
where prd_end_dt < prd_start_dt



--silver.crm_sales_details table
print '<<Truncating table:  silver.crm_sales_details';
truncate table  silver.crm_sales_details;
print '<<Inserting data into: silver.crm_sales_details';
insert into silver.crm_sales_details (

sls_ord_num,
sls_prd_key,
sls_cust_id,
sls_order_dt,
sls_ship_dt,
sls_due_dt,
sls_sales,
sls_quantity,
sls_price
)
select
sls_ord_num,
sls_prd_key,
sls_cust_id,
case when sls_order_dt = 0 or len(sls_order_dt) != 8 then null
else cast(cast(sls_order_dt  as varchar) as date)
end as sls_order_dt,
case when sls_ship_dt = 0 or len(sls_ship_dt) != 8 then null
else cast(cast(sls_ship_dt  as varchar) as date)
end as sls_ship_dt,
case when sls_due_dt = 0 or len(sls_due_dt) != 8 then null
else cast(cast(sls_due_dt  as varchar) as date)
end as sls_due_dt,
case when sls_sales <= 0 or sls_sales  is null or sls_sales != sls_quantity * abs(sls_price)
then sls_quantity * abs(sls_price)
else sls_sales
end as sls_sales,
sls_quantity,
case when sls_price is null or sls_price <= 0 then 
 sls_sales / nullif(sls_quantity,0)
else sls_price
end as sls_price
from 
bronze.crm_sales_details


--check for empty spaces
where sls_ord_num != trim(sls_ord_num)

--check that data used as keys is in the same in each table
where sls_prd_key not in (select prd_key from silver.crm_prd_info)
where sls_cust_id not in (select cst_id from silver.crm_cust_info)

--check for invalid dates - data is int same checks for ship_dt and due_dt
select
sls_order_dt
from
bronze.crm_sales_details
where sls_order_dt  <= 0 or len(sls_order_dt) != 8 or sls_order_dt > 20500101 or sls_order_dt < 19000101

select
*
from bronze.crm_sales_details
where sls_order_dt > sls_ship_dt or sls_order_dt > sls_due_dt

--check sales data
Select distinct
sls_sales as old_sales,
sls_quantity,
sls_price as old_price,

case when sls_sales <= 0 or sls_sales  is null or sls_sales != sls_quantity * abs(sls_price)
then sls_quantity * abs(sls_price)
else sls_sales
end as sls_sales,

case when sls_price is null or sls_price <= 0 then 
 sls_sales / nullif(sls_quantity,0)
else sls_price
end as sls_price

from
bronze.crm_sales_details
where sls_sales != sls_quantity * sls_price
or sls_sales is null or sls_quantity is null or sls_price is null
or sls_sales <= 0 or sls_quantity <= 0 or sls_price <= 0

--business rules
--if sales negative, 0, or null then use quantity and price
--if price is 0 or null use sales and quantity
--if price is negative convert to positive

--update table
if object_id ('silver.crm_sales_details' , 'U') is not null
 drop table silver.crm_sales_details;
create table silver.crm_sales_details (
sls_ord_num nvarchar(50),
sls_prd_key nvarchar(50),
sls_cust_id int,
sls_order_dt date,
sls_ship_dt date,
sls_due_dt date,
sls_sales int,
sls_quantity int,
sls_price int,
dwh_create_date datetime2 default getdate()
);

--ERP files
--silver erp_cust_az12
print '<<Truncating table:  silver.erp_cust_az12';
truncate table  silver.erp_cust_az12;
print '<<Inserting data into: silver.erp_cust_az12';
insert into silver.erp_cust_az12 (
cid,
bdate,
gen
)
select

case when cid like 'nas%' then substring (cid, 4, len(cid))
else cid
end as cid,
case when bdate > getdate() then null
else bdate
end as bdate,
case when upper(trim(gen)) in ('F' , 'FEMALE') then 'Female'
when upper(trim(gen)) in ('M' , 'MALE') then 'Male'
else 'N/A'
end as gen
from
bronze.erp_cust_az12

--check bdate range
select
bdate
from

--data standardization

select distinct
gen
from 
bronze.erp_cust_az12
bronze.erp_cust_az12
where bdate < '1924-01-01' or bdate > getdate()


--silver.erp_loc_a101
print '<<Truncating table:  silver.erp_loc_a101';
truncate table  silver.erp_loc_a101;
print '<<Inserting data into: silver.erp_loc_a101';
insert into silver.erp_loc_a101 (
cid,
cntry
)
select
replace (cid, '-', ' ') as cid,
case when upper(trim(cntry)) in ( 'USA', 'US', 'UNITED STATES') then 'United States'
when upper(trim(cntry)) in ('DE', 'GERMANY') then 'Germany'
when trim(cntry) = ' ' or cntry is null then 'N/A'
else trim(cntry)
end as cntry
from
bronze.erp_loc_a101

--data standardization
select cst_key from silver.crm_cust_info

select distinct
cntry
from
bronze.erp_loc_a101

--silver.erp_px_cat_g1v2
print '<<Truncating table:  silver.erp_px_cat_g1v2';
truncate table  silver.erp_px_cat_g1v2;
print '<<Inserting data into: silver.erp_px_cat_g1v2';
insert into silver.erp_px_cat_g1v2(
id,
cat,
subcat,
maintenance
)
select
id,
cat,
subcat,
maintenance
from
bronze.erp_px_cat_g1v2

--check for unwanted spaces
select * from bronze.erp_px_cat_g1v2
where cat != trim(cat) or subcat != trim(subcat) or maintenance != trim(maintenance)

--data standardization cat, subcat, and maintenance
select distinct
maintenance
from
bronze.erp_px_cat_g1v2
*/

/*

Quality checks for Gold Layer

gold.dim_customers

--check for duplicates after join
select cst_id, count(*) 
from
(
select
ci.cst_id,
ci.cst_key,
ci.cst_firstname,
ci.cst_lastname,
ci.cst_marital_status,
ci.cst_gndr,
ci.cst_create_date,
ca.bdate,
ca.gen,
la.cntry
from
silver.crm_cust_info as ci
left join silver.erp_cust_az12 as ca
on ci.cst_key = ca.cid
left join silver.erp_loc_a101 as la
on ci.cst_key = la.cid
)t group by cst_id
having count (*) > 1

--checking data from same column data information
select distinct
ci.cst_gndr,
ca.gen,
case when ci.cst_gndr != 'N/A' then ci.cst_gndr  --CRM is the master for gender
else coalesce (ca.gen, 'N/A')
end as new_gen
from
silver.crm_cust_info as ci
left join silver.erp_cust_az12 as ca
on ci.cst_key = ca.cid
left join silver.erp_loc_a101 as la
on ci.cst_key = la.cid
order by 1,2
use DWH_project

gold,dim_products

--check for duplicates after join
select prd_key, count(*) from
(
select
pn.prd_id,
pn.cat_id,
pn.prd_key,
pn.prd_nm,
pn.prd_cost,
pn.prd_line,
pn.prd_start_dt,
--pn.prd_end_dt
pc.cat,
pc.subcat,
pc.maintenance
from silver.crm_prd_info as pn
left join silver.erp_px_cat_g1v2 as pc
on pn.cat_id = pc.id
where pn.prd_end_dt is null
)t group by prd_key
having count(*) > 1

gold.fact_sales

--foreign key integrity

select
*
from
gold.fact_sales as s
left join gold.dim_customers as c
on c.customer_key = s.customer_key
left join gold.dim_products p
on p.product_key = s.product_key
where p.product_key is null

*/

